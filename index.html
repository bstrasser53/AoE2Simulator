<!DOCTYPE html>
<html>

<head>
  <title>AoE Simulator</title>
	<meta charset="UTF-8">
	<meta name="description" content="Simulator for Age of Empires 2">
	<meta name="keywords" content="AoE2, Age of Empires 2, AoE Tools, AoE Simulator">
	<meta name="author" content="Bernhard Strasser">	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>



<body onload="InitializeState();">

<h2>AoE Simulator</h2>
<p id="WrittenBy">Written by Bernhard Strasser ([o.p.]kanalratte). Version 0.2.</p>
<p id="UseOrReuse">Feel free to use or reuse this html & javascript code.</p>
<p id="Comment">Based on the gathering rate values of Spirit of the Law: <a href="https://www.youtube.com/watch?v=izBnksYw-kM">for gold & wood</a>, <a href="https://www.youtube.com/watch?v=MaqvJMEj69k&t=150s">for farms</a>.</p>


<br>
<label for="lPickedCiv">Which Civ?:</label>
<select name="sPickedCiv" id="sPickedCiv">
	<option value="Generic">Generic</option>
<!--	<option value="Khmer">Khmer</option>
	<option value="Slavs">Slavs</option>
	<option value="Aztecs">Aztecs</option>
	<option value="Berber">Berber</option>
	<option value="Mayans">Mayans</option>
	<option value="Burgundians">Burgundians</option>
	<option value="Portuguese">Portuguese</option> -->
</select>
<br>
<br>
<br>


<table id="CurResources">
	<tr>
		<th>Wood</th>
		<th>Food</th>
		<th>Gold</th>
		<th>Stone</th> &nbsp &nbsp &nbsp &nbsp
		
		
		<th>Pop</th>
		<th>Vils</th>
		<th>Idles</th>
		<th>Builders</th>
		<th>Walkers</th>
		<th>Shepherds</th>
		<th>BoarHunters</th>
		<th>DeerHunters</th>
		<th>BerryPickers</th>
		<th>Farmers</th>
		<th>Lumberjacks</th>
		<th>StragglerLumberjacks</th>
		<th>GoldMiners</th>
		<th>StoneMiners</th>
	</tr>
	<tr>
		<td id="CurWoodNumber">20</td>
		<td id="CurFoodNumber">200</td>
		<td id="CurGoldNumber">100</td>
		<td id="CurStoneNumber">200</td>

		<td id="CurPop">0</td>
		<td id="CurVils">0</td>		
		<td id="CurIdles">0</td>
		<td id="CurBuilders">0</td>
		<td id="CurWalkers">0</td>
		<td id="CurShepherds">3</td>
		<td id="CurBoarHunters">0</td>
		<td id="CurDeerHunters">0</td>
		<td id="CurBerryPickers">0</td>
		<td id="CurFarmers">0</td>
		<td id="CurLumberjacks">0</td>
		<td id="CurStragglerLumberjacks">0</td>
		<td id="CurGoldMiners">0</td>
		<td id="CurStoneMiners">0</td>
		
	</tr>
</table>

<br>
<br>
<br>


<!--Build Icons-->

<p id="TCs">TCs: &nbsp &nbsp  &nbsp  &nbsp &nbsp Barracks &nbsp &nbsp &nbsp Archeries &nbsp &nbsp &nbsp Stables &nbsp &nbsp &nbsp Monastaries &nbsp &nbsp &nbsp &nbsp Siege Workshops &nbsp &nbsp &nbsp Castles</p>
<input type="image" src="./Pix/villager.png" onClick="javascript:BuildUnit(AoESim,'Villager')" width="40" height="40" />
<input type="image" src="./Pix/shepherd.png" onClick="javascript:BuildSheepVil(AoESim)" width="40" height="40" />
<input type="image" src="./Pix/boar.webp" onClick="javascript:BuildBoarVil()" width="40" height="40" />
<input type="image" src="./Pix/deer.png" onClick="javascript:BuildDeerVil()" width="40" height="40" />
<input type="image" src="./Pix/tree.webp" onClick="javascript:BuildWoodVil()" width="40" height="40" />

<input type="image" src="./Pix/ArrowRight.png" onClick="javascript:AdvanceToNextEvent(AoESim)" width="40" height="40" />

<br>
<!--<input type="image" src="./Pix/farmer.png" onClick="javascript:CalcGatherratesAndUpdateOutput()" width="40" height="40" />-->
<!--<input type="image" src="./Pix/gold_miner.png" onClick="javascript:CalcGatherratesAndUpdateOutput()" width="40" height="40" />-->
<!--<input type="image" src="./Pix/stone_miner.png" onClick="javascript:CalcGatherratesAndUpdateOutput()" width="40" height="40" />-->
<!--<input type="image" src="./Pix/wheelbarrow.png" onClick="javascript:CalcGatherratesAndUpdateOutput()" width="40" height="40" />-->
<!--<input type="image" src="./Pix/hand_cart.png" onClick="javascript:CalcGatherratesAndUpdateOutput()" width="40" height="40" />-->




<!--
<form>
  <table id="InputTable">
    <tr>
      <td align="right">Vils on Farms:</td>
      <td align="left"><input type="number" value="10" name="VilsOnFarms" /></td>
    </tr>
    <tr>
      <td align="right">Vils on Wood:</td>
      <td align="left"><input type="number" value="18" name="VilsOnWood" /></td>
    </tr>
    <tr>
      <td align="right">Vils on Gold:</td>
      <td align="left"><input type="number" value="6" name="VilsOnGold" /></td>
    </tr>
    <tr>
      <td align="right">Number of Town Centers:</td>
      <td align="left"><input type="number" value="1" name="NoOfTCs" /></td>
    </tr>
  </table>
</form>
-->


<br>
<br>
<br>
<br>

<p id="Output0"></p>
<p id="Output1"></p>
<p id="Output2"></p>
<p id="Output3"></p>
<p id="Output4"></p>
<p id="Output5"></p>
<p id="Output6"></p>


<!-- DEBUG: -->
<!-- ->
<p id="Output7"></p>
<p id="Output8"></p>
<p id="Output9"></p>
<p id="Output10"></p>
<!- -->


<script>

var AoESim;
function InitializeState() 
{
	
	AoESim = {
		State: {
			Time: 0,
			CurEventIndex: 0,
			Resources: [200,200,100,200],		// Wood, Food, Gold, Stone
			Pop: 4,
			TotalVils: 3,
			Vils: {
				Idles: 0,
				Builders: 0,
				Walkers: 0,
				Shepherds: 3,
				BoarHunters: 0,
				DeerHunters: 0,
				BerryPickers: 0,
				Farmers: 0,
				Lumberjacks: 0,
				StragglerLumberjacks: 0,
				GoldMiners: 0,
				StoneMiners: 0
			},
			GatherRates: {
				Shepherds: 1,
				Hunters: 1,
				Farmers: 1,
				BerryPickers: 1,
				Lumberjacks: 1,
				StragglerLumberjacks: 1,
				GoldMiners: 1,
				StoneMiners: 1
				
			},
			WalkTimes: {
				TCToBuilder: 15,
				TCToWalker: 0,
				TCToShepherds: 5,
				TCToHunters: 5,
				TCToBerries: 20,
				TCToFarmers: 10,
				TCToLumberjacks: 20,
				TCToStragglerLumberjacks: 10,
				TCToGoldMiners: 20,
				TCToStoneMiners: 20,
				Generic: 10
			},
			Buildings: { // If 2-element array, first index gives how man buildins exist, while second gives number of idle buildings. For farms and fishtraps, this shows unoccupied farms/traps
				TownCenter: [1,1],
				House: 0,
				Mill: 0,
				Farm: [0,0],
				LumberCamp: 0,
				MiningCamp: 0,
				Dock: [0,0],
				Barrack: [0,0],
				Palisade: 0,
				PalisadeGate: 0,
				Outpost: 0,
				Market: 0,
				Blacksmith: [0,0],
				FishTrap: [0,0],
				ArcheryRange: [0,0],
				Stable: [0,0],
				StoneWall: 0,
				Gate: 0,
				WatchTower: 0,
				Donjon: [0,0],
				Monastery: [0,0],
				University: [0,0],
				SiegeWorkshop: [0,0],
				Castle: [0,0],
				Krepost: [0,0],
				BombardTower: 0,
				Feitoria: 0
			}
		},
		Events: [{
			EventTime: 0,
			EventFunction: "InitializeState();",
			UserVisible: 1
		}]
	};
		

	WriteOutResources(AoESim);
	WriteOutVils(AoESim);
	//return AoESim;
}


function WriteOutResources(AoESim) {

	document.getElementById("CurWoodNumber").innerHTML =  AoESim.State.Resources[0];
	document.getElementById("CurFoodNumber").innerHTML =  AoESim.State.Resources[1];
	document.getElementById("CurGoldNumber").innerHTML =  AoESim.State.Resources[2];
	document.getElementById("CurStoneNumber").innerHTML =  AoESim.State.Resources[3];
}
function WriteOutVils(AoESim) {

	document.getElementById("CurPop").innerHTML =  AoESim.State.Pop;
	document.getElementById("CurVils").innerHTML =  AoESim.State.TotalVils;
	document.getElementById("CurIdles").innerHTML =  AoESim.State.Vils.Idles;
	document.getElementById("CurBuilders").innerHTML =  AoESim.State.Vils.Builders;
	document.getElementById("CurWalkers").innerHTML =  AoESim.State.Vils.Walkers;
	document.getElementById("CurShepherds").innerHTML =  AoESim.State.Vils.Shepherds;
	document.getElementById("CurBoarHunters").innerHTML =  AoESim.State.Vils.BoarHunters;
	document.getElementById("CurDeerHunters").innerHTML =  AoESim.State.Vils.DeerHunters;
	document.getElementById("CurBerryPickers").innerHTML =  AoESim.State.Vils.BerryPickers;
	document.getElementById("CurFarmers").innerHTML =  AoESim.State.Vils.Farmers;
	document.getElementById("CurLumberjacks").innerHTML =  AoESim.State.Vils.Lumberjacks;
	document.getElementById("CurStragglerLumberjacks").innerHTML =  AoESim.State.Vils.StragglerLumberjacks;
	document.getElementById("CurGoldMiners").innerHTML =  AoESim.State.Vils.GoldMiners;
	document.getElementById("CurStoneMiners").innerHTML =  AoESim.State.Vils.StoneMiners;
}

function AdvanceToNextEvent(AoESim) {

	var NextEventTime = AoESim.Events[AoESim.State.CurEventIndex+1].EventTime;
	var AnyEventVisible = 0;

	for (let ii = AoESim.State.CurEventIndex+1; ii < AoESim.Events.length; ii++) {
		// Run all events that have the same EventTime as the next one
		if(AoESim.Events[ii].EventTime === NextEventTime)
		{
			// Run EventFunction
			if(AoESim.Events[ii].EventFunction != "")
			{
				eval(AoESim.Events[ii].EventFunction);
			}
			
			// Gather Resources
			var ElapsedTime = NextEventTime - AoESim.State.Time;	
			AoESim.State.Resources[0] = AoESim.State.Resources[0] + (AoESim.State.Vils.Lumberjacks*AoESim.State.GatherRates.Lumberjacks +
												AoESim.State.Vils.StragglerLumberjacks*AoESim.State.GatherRates.StragglerLumberjacks) * ElapsedTime;
			AoESim.State.Resources[1] = AoESim.State.Resources[1] + (AoESim.State.Vils.Shepherds*AoESim.State.GatherRates.Shepherds +
												(AoESim.State.Vils.DeerHunters+AoESim.State.Vils.BoarHunters)*AoESim.State.GatherRates.Hunters +
												AoESim.State.Vils.Farmers*AoESim.State.GatherRates.Farmers + 
												AoESim.State.Vils.BerryPickers*AoESim.State.GatherRates.BerryPickers) * ElapsedTime; 
			AoESim.State.Resources[2] = AoESim.State.Resources[2] + AoESim.State.Vils.GoldMiners*AoESim.State.GatherRates.GoldMiners * ElapsedTime;			
			AoESim.State.Resources[3] = AoESim.State.Resources[3] + AoESim.State.Vils.StoneMiners*AoESim.State.GatherRates.StoneMiners * ElapsedTime;						
			
			// Update Current Time & CurEventIndex
			AoESim.State.Time = NextEventTime;
			AoESim.State.CurEventIndex = ii;	
			
			if(AoESim.Events[ii].UserVisible === 1)
			{
				AnyEventVisible = 1;
			}

		}
		else
		{
			break;
		}

	}
	WriteOutResources(AoESim);
	WriteOutVils(AoESim);

	// Immediately proceed to next event, if all events should not be visible for user (e.g. an automatic retasking of Walker-vil --> Shepherd should not be visible for user)
	if(AnyEventVisible === 0)
	{
		AdvanceToNextEvent(AoESim);
	}
	
}

function DetermineEventIndex(AoESim,EventTime){

	// If there is already an event that should come after our event, put it at the index of that event, and move all later events further back. Otherwise put new event as last event.
	var EventIndex = AoESim.Events.length;
	for (let ii = AoESim.State.CurEventIndex; ii < AoESim.Events.length; ii++) {
		if(EventTime < AoESim.Events[ii].EventTime){
			EventIndex = ii;
			break;
		} 
	}
	return EventIndex;
}

function BuildUnit(AoESim,UnitName,UnitTask) {

	UnitStatsTmp = UnitStats(UnitName);
	
	// Only build unit if we have a building idle to build that unit
	if(AoESim.State.Buildings[UnitStatsTmp.OccupyBuilding][1] > 0 && AoESim.State.Resources.AllElementsGreaterOrEqual(UnitStatsTmp.Cost))
	{
		AoESim.State.Resources = subtractvector(AoESim.State.Resources, UnitStatsTmp.Cost);
		AoESim.State.Buildings[UnitStatsTmp.OccupyBuilding][1] = AoESim.State.Buildings[UnitStatsTmp.OccupyBuilding][1] - 1;
		WriteOutResources(AoESim);

		// Add Event to Add Unit
		// Determine where to add the event
		var IndexOfEvent = DetermineEventIndex(AoESim,AoESim.State.Time + UnitStatsTmp.TrainTime);
		// Events of AddUnit should always be visible for user, because this means some building is getting idle! 
		AoESim.Events.splice(IndexOfEvent,0, {EventTime: AoESim.State.Time + UnitStatsTmp.TrainTime, EventFunction: "AddUnit(AoESim, '" + UnitName + "', '" + UnitTask + "');", UserVisible: 1});	
		return 0;
	}
	return 1;
}


function AddUnit(AoESim,UnitName,UnitTask) {

	UnitStatsTmp = UnitStats(UnitName);
	if(UnitName === "Villager")
	{
		AoESim.State.TotalVils = AoESim.State.TotalVils + 1;
		AoESim.State.Pop = AoESim.State.Pop + 1;
		AoESim.State.Vils[UnitTask] = AoESim.State.Vils[UnitTask] + 1;
		WriteOutVils(AoESim);
	}
	AoESim.State.Buildings[UnitStatsTmp.OccupyBuilding][1] = AoESim.State.Buildings[UnitStatsTmp.OccupyBuilding][1] + 1;
	
}

function RetaskVillager(AoESim,RetaskFrom,RetaskTo) {
	AoESim.State.Vils[RetaskFrom] = AoESim.State.Vils[RetaskFrom] - 1;
	AoESim.State.Vils[RetaskTo] = AoESim.State.Vils[RetaskTo] + 1;
	WriteOutVils(AoESim);
}

function BuildSheepVil(AoESim) {
	var ErrorOccurred = BuildUnit(AoESim,'Villager','Walkers');
	if(ErrorOccurred === 0)
	{	
		var IndexOfEvent = DetermineEventIndex(AoESim,AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToShepherds);
		AoESim.Events.splice(IndexOfEvent,0, {EventTime: AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToShepherds, EventFunction: "RetaskVillager(AoESim,'Walkers','Shepherds');", UserVisible: 0	});	// Not necessary for user to see this event
	}
}




function BuildBoarVil() {
	var ErrorOccurred = BuildUnit(AoESim,'Villager','Walkers');
	if(ErrorOccurred === 0)
	{
		var IndexOfEvent = DetermineEventIndex(AoESim,AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToHunters);
		AoESim.Events.splice(IndexOfEvent,0, {EventTime: AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToHunters, EventFunction: "RetaskVillager(AoESim,'Walkers','BoarHunters');", UserVisible: 0	});	// Not necessary for user to see this event
	}
}

function BuildDeerVil() {
	var ErrorOccurred = BuildUnit(AoESim,'Villager','Walkers');
	if(ErrorOccurred === 0)
	{
		var IndexOfEvent = DetermineEventIndex(AoESim,AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToHunters);
		AoESim.Events.splice(IndexOfEvent,0, {EventTime: AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToHunters, EventFunction: "RetaskVillager(AoESim,'Walkers','DeerHunters');", UserVisible: 0	});	// Not necessary for user to see this event
	}
}

function BuildWoodVil() {
	var ErrorOccurred = BuildUnit(AoESim,'Villager','Walkers');
	if(ErrorOccurred === 0)
	{
		var IndexOfEvent = DetermineEventIndex(AoESim,AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToLumberjacks);
		AoESim.Events.splice(IndexOfEvent,0, {EventTime: AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToLumberjacks, EventFunction: "RetaskVillager(AoESim,'Walkers','Lumberjacks');", UserVisible: 0	});	// Not necessary for user to see this event
	}
}

function BuildFarmVil() {

	//BuildUnit("Villager")
	//SendIdleVilToBoar()

}

function BuildGoldVil() {
	var ErrorOccurred = BuildUnit(AoESim,'Villager','Walkers');
	if(ErrorOccurred === 0)
	{
		var IndexOfEvent = DetermineEventIndex(AoESim,AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToGoldMiners);
		AoESim.Events.splice(IndexOfEvent,0, {EventTime: AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToGoldMiners, EventFunction: "RetaskVillager(AoESim,'Walkers','GoldMiners');", UserVisible: 0	});	// Not necessary for user to see this event
	}
}

function BuildStoneVil() {
	var ErrorOccurred = BuildUnit(AoESim,'Villager','Walkers');
	if(ErrorOccurred === 0)
	{
		var IndexOfEvent = DetermineEventIndex(AoESim,AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToStoneMiners);
		AoESim.Events.splice(IndexOfEvent,0, {EventTime: AoESim.State.Time + UnitStats("Villager").TrainTime + AoESim.State.WalkTimes.TCToStoneMiners, EventFunction: "RetaskVillager(AoESim,'Walkers','StoneMiners');", UserVisible: 0	});	// Not necessary for user to see this event
	}
}

/*
function ResearchWheelbarrow() {

	BuildUnit("Villager")
	//SendIdleVilToBoar()

}
function ResearchHandcart() {

	BuildUnit("Villager")
	//SendIdleVilToBoar()

}
*/

function UnitStats(UnitName) {
	Stats = {
		Cost: 0,
		OccupyBuilding: "",		// Wood, Food, Gold, Stone
		TrainTime: 0
	};
	if (UnitName === "Villager")
	{
		Stats.Cost = [0, 50, 0, 0];
		Stats.OccupyBuilding = "TownCenter"
		Stats.TrainTime = 25;
	}
	return Stats;

}


function addvector(a,b){
    return a.map((e,i) => e + b[i]);
}
function subtractvector(a,b){
    return a.map((e,i) => e - b[i]);
}



// attach the .ElementwiseEquals method to Array's prototype to call it on any array
Array.prototype.ElementwiseEquals = function (array) {
    // if the other array is a falsy value, return
    if (!array)
        return [0];

    // compare lengths - can save a lot of time 
    if (this.length != array.length)
        return [0];
	
	var	Output = new Array(array.length) 
    for (var ii = 0; ii < array.length; ii++) {
		Output[ii] = this[ii] === array[ii];
        }           
    return Output;
}
// Hide method from for-in loops
Object.defineProperty(Array.prototype, "ElementwiseEquals", {enumerable: false});

// attach the .ElementwiseGreaterOrEqual method to Array's prototype to call it on any array
Array.prototype.ElementwiseGreaterOrEqual = function (array) {
    // if the other array is a falsy value, return
    if (!array)
        return [0];

    // compare lengths - can save a lot of time 
    if (this.length != array.length)
        return [0];
	
	var	Output = new Array(array.length) 
    for (var ii = 0; ii < array.length; ii++) {
		Output[ii] = this[ii] >= array[ii];
        }           
    return Output;
}
// Hide method from for-in loops
Object.defineProperty(Array.prototype, "ElementwiseGreaterOrEqual", {enumerable: false});


// attach the .AllElementsGreaterOrEqual method to Array's prototype to call it on any array
Array.prototype.AllElementsGreaterOrEqual = function (array) {
    // if the other array is a falsy value, return
    if (!array)
        return false;

    // compare lengths - can save a lot of time 
    if (this.length != array.length)
        return false;
	
	var	Output = true; 
    for (var ii = 0; ii < array.length; ii++) {
		if(this[ii] < array[ii])
		{
			Output = false;
			return Output;
		}
    }           
    return Output;
}
// Hide method from for-in loops
Object.defineProperty(Array.prototype, "AllElementsGreaterOrEqual", {enumerable: false});



</script>


</body>
</html>
